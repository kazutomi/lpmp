#!/usr/bin/env ruby
# coding: utf-8

$in_lines = nil
$out_lines = nil

NPass = 2  # two-pass processing

def process_kw(l)
  l.gsub(/@<kw>{([^,}]+)(,[^}]+)?}/){"**#{$1}**"}  # ignore yomi for now
end

def process_ruby(l)
  l.gsub(/@<ruby>{([^,]+),([^}]+)}/){"#{$1}^#{$2}^"}
end

def process(l)
  s = nil
  if /^@@/ =~ l
    # reserved for line directive
    s = nil
  else
    s = process_kw(l)
    s = process_ruby(s) unless s.nil?
  end
  s
end

def main
  $in_lines = ARGF.readlines
  NPass.times do
    $out_lines = []
    $in_lines.each do |l|
      s = process(l)
      $out_lines << s unless s.nil?
    end
  end
  $out_lines.each do |l|
    puts l
  end
end

main
0
